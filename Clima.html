<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clima</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#e6f3ff; --bg2:#f8fbff; --card:#ffffffcc; --muted:#4b5563; --text:#0b2545;
      --accent:#00a8e8; --accent2:#ffd166; --chip:#eef6ff88; --border:#cfe7ff;
      --shadow: 0 8px 30px rgba(0, 94, 184, .12);
      --g-sunny: linear-gradient(180deg, #dff3ff 0%, #f4fbff 60%, #ffffff 100%);
      --g-cloudy: linear-gradient(180deg, #eaf2f8 0%, #f6f9fb 60%, #ffffff 100%);
      --g-rain: linear-gradient(180deg, #dfeaf6 0%, #ecf3fb 60%, #ffffff 100%);
      --g-storm: linear-gradient(180deg, #dfe7f5 0%, #edf2fa 60%, #ffffff 100%);
      --g-snow: linear-gradient(180deg, #eef6ff 0%, #f7fbff 60%, #ffffff 100%);
      --g-fog: linear-gradient(180deg, #eef3f6 0%, #f7fafc 60%, #ffffff 100%);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0c1b2a; --bg2:#0f2236; --card:#0f263bcc; --muted:#9fb4c7; --text:#e6f1fb;
        --accent:#4cc3ff; --accent2:#ffd166; --chip:#10304acc; --border:#1f3e5a;
        --shadow: 0 8px 30px rgba(0, 0, 0, .35);
        --g-sunny: linear-gradient(180deg, #0c1b2a 0%, #0f2236 60%, #0b1724 100%);
        --g-cloudy: linear-gradient(180deg, #0c1823 0%, #0f1f2e 60%, #0b131d 100%);
        --g-rain: linear-gradient(180deg, #0b1a28 0%, #0e2032 60%, #0a1522 100%);
        --g-storm: linear-gradient(180deg, #0a1724 0%, #0e1d2c 60%, #0a1420 100%);
        --g-snow: linear-gradient(180deg, #0b1a29 0%, #0e2133 60%, #0a1623 100%);
        --g-fog: linear-gradient(180deg, #0a1622 0%, #0d1c2a 60%, #09131d 100%);
      }
    }
    body.dark{
      --bg:#0c1b2a; --bg2:#0f2236; --card:#0f263bcc; --muted:#9fb4c7; --text:#e6f1fb;
      --accent:#4cc3ff; --chip:#10304acc; --border:#1f3e5a;
      --g-sunny: linear-gradient(180deg, #0c1b2a 0%, #0f2236 60%, #0b1724 100%);
      --g-cloudy: linear-gradient(180deg, #0c1823 0%, #0f1f2e 60%, #0b131d 100%);
      --g-rain: linear-gradient(180deg, #0b1a28 0%, #0e2032 60%, #0a1522 100%);
      --g-storm: linear-gradient(180deg, #0a1724 0%, #0e1d2c 60%, #0a1420 100%);
      --g-snow: linear-gradient(180deg, #0b1a29 0%, #0e2133 60%, #0a1623 100%);
      --g-fog: linear-gradient(180deg, #0a1622 0%, #0d1c2a 60%, #09131d 100%);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Poppins, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--g-sunny); color:var(--text); min-height:100vh;
      display:flex; flex-direction:column; gap:16px; transition: background 1200ms ease;
    }
    /* Animated background sheen */
    .bg-anim{
      position:fixed; inset:-20vh -20vw; z-index:0; pointer-events:none;
      background: radial-gradient(1200px 1200px at var(--x,50%) var(--y,30%), rgba(255,255,255,.25), transparent 55%);
      mix-blend-mode: soft-light; animation: drift 16s ease-in-out infinite;
    }
    @keyframes drift{
      0%{ --x:20%; --y:25% } 50%{ --x:80%; --y:35% } 100%{ --x:20%; --y:25% }
    }

    /* Effects canvas */
    #fx{
      position:fixed; inset:0; z-index:1; pointer-events:none; opacity:.9;
    }

    .flag-band{ height:10px; background: linear-gradient(90deg, #7ec8ff 0%, #aee1ff 50%, #7ec8ff 100%); box-shadow:0 2px 6px rgba(0,0,0,.04) inset; z-index:2 }
    header{ padding:18px 16px 8px; display:flex; flex-wrap:wrap; align-items:center; gap:12px; justify-content:center; position:relative; z-index:3 }
    .app-title{ font-size:clamp(20px,2.5vw,28px); font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px; backdrop-filter: blur(6px) saturate(120%); padding:6px 10px; border-radius:12px; }
    .sun{ width:22px; height:22px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffe8a3 10%, var(--accent2) 60%, #f3b547 100%); box-shadow:0 0 0 4px rgba(255,209,102,.25), 0 0 20px rgba(255,209,102,.35); animation: sun-pulse 4s ease-in-out infinite; }
    @keyframes sun-pulse{ 0%,100%{ transform: rotate(0deg) scale(1)} 50%{ transform: rotate(8deg) scale(1.05)} }
    .bar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; }
    input[type=text]{ background:var(--card); border:1px solid var(--border); color:var(--text); padding:12px 14px; border-radius:14px; min-width:260px; box-shadow:var(--shadow); backdrop-filter: blur(8px); }
    button{ background:linear-gradient(135deg,var(--accent), #6ed3ff); color:#053049; border:0; padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer; box-shadow:0 8px 22px rgba(0,168,232,.25) }
    button.secondary{ background:var(--chip); color:var(--text); border:1px solid var(--border); box-shadow:none; backdrop-filter: blur(8px); }
    .toggle{ background:var(--chip); color:var(--text); border:1px solid var(--border); padding:10px 12px; border-radius:12px; font-weight:700; backdrop-filter: blur(8px); }
    main{ width:min(1100px,94%); margin:0 auto 36px; display:grid; gap:14px; position:relative; z-index:2 }
    .meta{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; padding:0 4px; }
    .where{ font-size:18px; font-weight:700; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ background:var(--chip); color:#246fa0; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:13px; backdrop-filter: blur(6px); }
    .current{
      display:grid; grid-template-columns: 1fr; gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.50));
      border:1px solid var(--border); border-radius:20px; padding:16px; box-shadow:var(--shadow);
      backdrop-filter: blur(8px) saturate(120%);
      transition: border-color .3s ease, background .3s ease;
    }
    .current-main{ display:flex; align-items:center; gap:14px; }
    .current-icon{ width:56px; height:56px; display:inline-flex; align-items:center; justify-content:center }
    .current-temp{ font-size:34px; font-weight:900; color:#053049 }
    .current-desc{ color:#395979; font-weight:700 }
    .current-extra{ display:flex; gap:12px; flex-wrap:wrap; }
    .badge{ background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:13px; color:#246fa0; backdrop-filter: blur(6px); }
    .cards{ display:grid; grid-template-columns: repeat(auto-fill,minmax(190px,1fr)); gap:14px }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45)); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:var(--shadow); backdrop-filter: blur(8px) saturate(120%); }
    .card.today{ border:2px solid var(--accent) }
    .date{ color:#246fa0; font-size:13px; margin-bottom:6px; font-weight:700; letter-spacing:.2px; text-transform:uppercase }
    .big{ display:flex; align-items:center; gap:10px; margin:6px 0 10px }
    .icon{ width:42px; height:42px; display:inline-flex; align-items:center; justify-content:center }
    .temp{ font-size:26px; font-weight:900; color:#053049 }
    .desc{ color:#395979; font-size:13px; margin-bottom:10px }
    .row{ display:flex; justify-content:space-between; font-size:13px; margin:4px 0 }
    footer{ text-align:center; color:#246fa0; font-size:12px; padding:0 12px 20px; position:relative; z-index:2 }
    .loader{ display:flex; align-items:center; justify-content:center; gap:10px; padding:18px }
    .cloud{ width:46px; height:26px; border-radius:999px; background:#fff; position:relative; box-shadow: var(--shadow); animation: float 2.2s ease-in-out infinite }
    .cloud::before,.cloud::after{ content:""; position:absolute; background:#fff; border-radius:999px }
    .cloud::before{ width:28px; height:28px; left:-10px; top:-10px }
    .cloud::after{ width:34px; height:34px; right:-8px; top:-14px }
    @keyframes float{ 0%,100%{ transform: translateY(0)} 50%{ transform: translateY(-6px)} }
    body[data-theme="sunny"]{ background: var(--g-sunny) }
    body[data-theme="cloudy"]{ background: var(--g-cloudy) }
    body[data-theme="rain"]{ background: var(--g-rain) }
    body[data-theme="storm"]{ background: var(--g-storm) }
    body[data-theme="snow"]{ background: var(--g-snow) }
    body[data-theme="fog"]{ background: var(--g-fog) }
  </style>
</head>
<body>
  <div class="bg-anim" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true"></canvas>
  <div class="flag-band" aria-hidden="true"></div>
  <header>
    <div class="app-title"><span class="sun" aria-hidden="true"></span> Clima ‚Äî Minimal & Modern</div>
    <div class="bar">
      <input id="city" type="text" placeholder="Buscar ciudad (ej: Buenos Aires)"/>
      <button id="search" aria-label="Buscar ciudad">Buscar</button>
      <button id="geo" class="secondary" aria-label="Usar mi ubicaci√≥n">Usar mi ubicaci√≥n</button>
      <button id="toggle-theme" class="toggle" aria-label="Cambiar tema">üåì Auto</button>
      <button id="toggle-unit" class="toggle" aria-label="Cambiar unidades">¬∞C</button>
    </div>
  </header>

  <main>
    <section class="meta">
      <div class="where" id="place" aria-live="polite">Cargando ubicaci√≥n‚Ä¶</div>
      <div class="chips" id="meta-chips">
        <span class="chip" id="tz"></span>
        <span class="chip" id="updated"></span>
        <span class="chip" id="unit-chip">Unidad: ¬∞C</span>
        <span class="chip" id="theme-chip">Tema: Auto</span>
      </div>
    </section>

    <!-- Current conditions -->
    <section class="current" id="current" aria-live="polite">
      <div class="current-main">
        <div class="current-icon" id="current-icon"></div>
        <div>
          <div class="current-temp" id="current-temp">‚Äî</div>
          <div class="current-desc" id="current-desc">Cargando condiciones‚Ä¶</div>
        </div>
      </div>
      <div class="current-extra" id="current-extra">
        <!-- badges -->
      </div>
    </section>

    <!-- Forecast cards -->
    <section class="cards" id="cards"></section>
  </main>

  <footer>
    Tema: <b>Celeste & Blanco</b> ‚Ä¢ Fuente: <a href="https://open-meteo.com" target="_blank" rel="noreferrer">Open‚ÄëMeteo</a> (sin API key).
  </footer>

  <script>
    const $ = (sel)=>document.querySelector(sel);

    const prefs = {
      unit: localStorage.getItem('unit') || 'C',
      theme: localStorage.getItem('theme') || 'auto'
    };

    function unitSymbol(){ return prefs.unit === 'C' ? '¬∞C' : '¬∞F'; }
    function convertTemp(c){ return prefs.unit === 'C' ? Math.round(c) : Math.round(c*9/5+32); }

    function updatePrefChips(){
      $("#unit-chip").textContent = 'Unidad: ' + unitSymbol();
      $("#theme-chip").textContent = 'Tema: ' + (prefs.theme==='auto'?'Auto':(prefs.theme==='dark'?'Oscuro':'Claro'));
      $("#toggle-unit").textContent = unitSymbol();
      $("#toggle-theme").textContent = (prefs.theme==='auto'?'üåì Auto':(prefs.theme==='dark'?'üåô Oscuro':'‚òÄÔ∏è Claro'));
    }
    function applyThemePref(){
      document.body.classList.remove('dark');
      if(prefs.theme === 'dark') document.body.classList.add('dark');
    }
    applyThemePref(); updatePrefChips();

    const WMO_DESC = {
      0:"Despejado",1:"Mayormente despejado",2:"Parcialmente nublado",3:"Nublado",
      45:"Niebla",48:"Niebla escarchada",51:"Llovizna d√©bil",53:"Llovizna",55:"Llovizna intensa",
      56:"Llovizna helada d√©bil",57:"Llovizna helada",61:"Lluvia d√©bil",63:"Lluvia",65:"Lluvia intensa",
      66:"Lluvia helada d√©bil",67:"Lluvia helada",71:"Nieve d√©bil",73:"Nieve",75:"Nieve intensa",
      77:"Granos de nieve",80:"Chaparr√≥n d√©bil",81:"Chaparr√≥n",82:"Chaparr√≥n fuerte",
      85:"Chaparr√≥n de nieve d√©bil",86:"Chaparr√≥n de nieve fuerte",95:"Tormenta",96:"Tormenta con granizo d√©bil",99:"Tormenta con granizo fuerte"
    };
    function codeToGroup(code){
      if([0,1].includes(code)) return 'sunny';
      if([2,3].includes(code)) return 'cloudy';
      if([45,48].includes(code)) return 'fog';
      if([71,73,75,77,85,86].includes(code)) return 'snow';
      if([95,96,99].includes(code)) return 'storm';
      if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return 'rain';
      return 'cloudy';
    }

    // Effects engine (minimal, performant)
    const fx = (()=>{
      const canvas = document.getElementById('fx');
      const ctx = canvas.getContext('2d');
      let w=0,h=0, mode='none', drops=[], flakes=[], bands=[], flash=0;
      const DPR = Math.min(2, window.devicePixelRatio || 1);

      function resize(){
        w = canvas.width = Math.floor(innerWidth*DPR);
        h = canvas.height = Math.floor(innerHeight*DPR);
        canvas.style.width = innerWidth+'px';
        canvas.style.height = innerHeight+'px';
        if(mode==='rain'){ makeRain(); }
        if(mode==='snow'){ makeSnow(); }
        if(mode==='fog'){ makeFog(); }
      }

      function makeRain(){
        const count = Math.floor((w*h)/(1400*DPR));
        drops = new Array(count).fill(0).map(()=> ({
          x: Math.random()*w,
          y: Math.random()*h,
          l: 10 + Math.random()*20*DPR,
          s: 3*DPR + Math.random()*4*DPR
        }));
      }
      function makeSnow(){
        const count = Math.floor((w*h)/(9000*DPR));
        flakes = new Array(count).fill(0).map(()=> ({
          x: Math.random()*w,
          y: Math.random()*h,
          r: 1*DPR + Math.random()*2*DPR,
          vy: .3*DPR + Math.random()*0.8*DPR,
          vx: (Math.random()-.5)*0.4*DPR
        }));
      }
      function makeFog(){
        const layers = 3;
        bands = new Array(layers).fill(0).map((_,i)=> ({
          y: (h/layers)*i + Math.random()*60*DPR,
          vy: 0.05*DPR + Math.random()*0.05*DPR,
          a: 0.05 + i*0.05
        }));
      }

      function clear(){
        ctx.clearRect(0,0,w,h);
      }

      function drawRain(){
        ctx.strokeStyle = 'rgba(86,169,255,0.55)';
        ctx.lineWidth = 1*DPR;
        ctx.beginPath();
        for(const d of drops){
          ctx.moveTo(d.x, d.y);
          ctx.lineTo(d.x, d.y + d.l);
          d.y += d.s;
          d.x += 0.6*DPR; // ligero viento
          if(d.y > h+20*DPR){ d.y = -20*DPR; d.x = Math.random()*w; }
        }
        ctx.stroke();
      }
      function drawSnow(){
        ctx.fillStyle = 'rgba(255,255,255,0.85)';
        for(const f of flakes){
          ctx.beginPath();
          ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
          ctx.fill();
          f.y += f.vy; f.x += f.vx;
          if(f.y > h+5*DPR){ f.y = -5*DPR; f.x = Math.random()*w; }
          if(f.x > w) f.x = 0; if(f.x < 0) f.x = w;
        }
      }
      function drawFog(){
        for(const b of bands){
          const grad = ctx.createLinearGradient(0, b.y-80*DPR, 0, b.y+80*DPR);
          grad.addColorStop(0,'rgba(200,210,220,0)');
          grad.addColorStop(0.5,`rgba(200,210,220,${b.a})`);
          grad.addColorStop(1,'rgba(200,210,220,0)');
          ctx.fillStyle = grad;
          ctx.fillRect(0, b.y-80*DPR, w, 160*DPR);
          b.y += b.vy;
          if(b.y-80*DPR > h) b.y = -80*DPR;
        }
      }
      function drawFlash(){
        if(flash>0){
          ctx.fillStyle = `rgba(255,255,255,${flash})`;
          ctx.fillRect(0,0,w,h);
          flash = Math.max(0, flash - 0.05);
        }else if(mode==='storm' && Math.random()<0.004){
          flash = 0.6 + Math.random()*0.2;
        }
      }

      function loop(){
        clear();
        if(mode==='rain' || mode==='storm') drawRain();
        if(mode==='snow') drawSnow();
        if(mode==='fog') drawFog();
        if(mode==='storm') drawFlash();
        requestAnimationFrame(loop);
      }

      window.addEventListener('resize', resize);
      resize(); loop();

      return {
        setMode(m){
          mode = m;
          if(m==='rain' || m==='storm') makeRain();
          else if(m==='snow') makeSnow();
          else if(m==='fog') makeFog();
        }
      };
    })();

    function setThemeFromCode(code){
      const group = codeToGroup(code);
      document.body.setAttribute('data-theme', group);
      // Map visual effects to group
      fx.setMode(
        group==='rain' ? 'rain' :
        group==='storm' ? 'storm' :
        group==='snow' ? 'snow' :
        group==='fog' ? 'fog' : 'none'
      );
    }

    // Pretty SVG icons (kept minimal/consistent)
    function getPrettyIconSVG(group){
      const icons = {
        sunny: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><radialGradient id="gSun" cx="30%" cy="30%" r="70%">
            <stop offset="0%" stop-color="#fff7b1"/><stop offset="60%" stop-color="#ffd166"/><stop offset="100%" stop-color="#f3b547"/>
          </radialGradient></defs>
          <circle cx="32" cy="32" r="14" fill="url(#gSun)"/>
          <g stroke="#f7c14a" stroke-width="3" stroke-linecap="round">
            <line x1="32" y1="6" x2="32" y2="14"/><line x1="32" y1="50" x2="32" y2="58"/>
            <line x1="6" y1="32" x2="14" y2="32"/><line x1="50" y1="32" x2="58" y2="32"/>
            <line x1="12" y1="12" x2="18" y2="18"/><line x1="46" y1="46" x2="52" y2="52"/>
            <line x1="46" y1="18" x2="52" y2="12"/><line x1="12" y1="52" x2="18" y2="46"/>
          </g></svg>`,
        cloudy: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><linearGradient id="gCloud" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e6eef7"/>
          </linearGradient></defs>
          <ellipse cx="28" cy="36" rx="16" ry="10" fill="url(#gCloud)"/>
          <ellipse cx="40" cy="34" rx="14" ry="9" fill="url(#gCloud)"/>
          <ellipse cx="20" cy="34" rx="10" ry="7" fill="url(#gCloud)"/></svg>`,
        rain: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><linearGradient id="gCloud2" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e6eef7"/>
          </linearGradient></defs>
          <g><ellipse cx="28" cy="30" rx="16" ry="10" fill="url(#gCloud2)"/>
          <ellipse cx="40" cy="28" rx="14" ry="9" fill="url(#gCloud2)"/>
          <ellipse cx="20" cy="28" rx="10" ry="7" fill="url(#gCloud2)"/></g>
          <g stroke="#56a9ff" stroke-width="3" stroke-linecap="round">
            <line x1="24" y1="44" x2="22" y2="52"/><line x1="34" y1="44" x2="32" y2="53"/><line x1="44" y1="44" x2="42" y2="52"/>
          </g></svg>`,
        storm: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><linearGradient id="gCloud3" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#f0f4f9"/><stop offset="100%" stop-color="#dfe8f2"/>
          </linearGradient></defs>
          <g><ellipse cx="28" cy="28" rx="16" ry="10" fill="url(#gCloud3)"/>
          <ellipse cx="40" cy="26" rx="14" ry="9" fill="url(#gCloud3)"/>
          <ellipse cx="20" cy="26" rx="10" ry="7" fill="url(#gCloud3)"/></g>
          <polygon points="30,36 24,50 31,50 28,60 42,42 35,42 38,36" fill="#ffcf4a" stroke="#e0ad2a" stroke-width="2"/></svg>`,
        snow: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><linearGradient id="gCloud4" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e6eef7"/>
          </linearGradient></defs>
          <g><ellipse cx="28" cy="30" rx="16" ry="10" fill="url(#gCloud4)"/>
          <ellipse cx="40" cy="28" rx="14" ry="9" fill="url(#gCloud4)"/>
          <ellipse cx="20" cy="28" rx="10" ry="7" fill="url(#gCloud4)"/></g>
          <g fill="#86c3ff"><circle cx="24" cy="46" r="2"/><circle cx="34" cy="48" r="2"/><circle cx="44" cy="46" r="2"/></g></svg>`,
        fog: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><linearGradient id="gCloud5" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e6eef7"/>
          </linearGradient></defs>
          <ellipse cx="32" cy="26" rx="18" ry="10" fill="url(#gCloud5)"/>
          <g stroke="#b3c4d6" stroke-width="3" stroke-linecap="round">
            <line x1="16" y1="40" x2="48" y2="40"/><line x1="12" y1="46" x2="52" y2="46"/>
          </g></svg>`,
        partly: `<svg viewBox="0 0 64 64" width="56" height="56" aria-hidden="true">
          <defs><radialGradient id="gSun2" cx="30%" cy="30%" r="70%">
            <stop offset="0%" stop-color="#fff7b1"/><stop offset="60%" stop-color="#ffd166"/><stop offset="100%" stop-color="#f3b547"/>
          </radialGradient><linearGradient id="gCloud6" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#e6eef7"/>
          </linearGradient></defs>
          <circle cx="24" cy="24" r="10" fill="url(#gSun2)"/>
          <ellipse cx="36" cy="34" rx="16" ry="10" fill="url(#gCloud6)"/></svg>`
      };
      return icons[group] || icons.cloudy;
    }
    function getIconByCode(code){
      if([0].includes(code)) return getPrettyIconSVG('sunny');
      if([1,2].includes(code)) return getPrettyIconSVG('partly');
      if([3].includes(code)) return getPrettyIconSVG('cloudy');
      if([45,48].includes(code)) return getPrettyIconSVG('fog');
      if([71,73,75,77,85,86].includes(code)) return getPrettyIconSVG('snow');
      if([95,96,99].includes(code)) return getPrettyIconSVG('storm');
      if([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return getPrettyIconSVG('rain');
      return getPrettyIconSVG('cloudy');
    }

    function renderLoader(){
      const el = document.createElement('article');
      el.className = 'card loader';
      el.innerHTML = '<span class="cloud" aria-hidden="true"></span> <span>Cargando‚Ä¶</span>';
      return el;
    }

    function renderCurrent(current, tz){
      const icon = getIconByCode(current.weather_code ?? 2);
      $("#current-icon").innerHTML = icon;
      $("#current-temp").textContent = `${convertTemp(current.temperature_2m)}${unitSymbol()}`;
      const desc = (current.weather_code!=null && Object.prototype.hasOwnProperty.call(WMO_DESC, current.weather_code)) ? WMO_DESC[current.weather_code] : "‚Äî";
      $("#current-desc").textContent = desc;

      const feels = convertTemp(current.apparent_temperature);
      const hum = current.relative_humidity_2m;
      const wind = Math.round(current.wind_speed_10m || 0);
      const t = new Date(current.time);
      const hour = t.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit", timeZone: tz});
      $("#current-extra").innerHTML = `
        <span class="badge">Sensaci√≥n: ${feels}${unitSymbol()}</span>
        <span class="badge">Humedad: ${hum}%</span>
        <span class="badge">Viento: ${wind} km/h</span>
        <span class="badge">Hora: ${hour}</span>`;
    }

    function renderDaily(data){
      const { daily, timezone } = data;
      const cards = $("#cards");
      cards.innerHTML = "";
      $("#tz").textContent = "TZ: " + timezone.replace("_"," ");
      $("#updated").textContent = "Actualizado: " + new Date().toLocaleTimeString();
      setThemeFromCode(daily.weathercode?.[0] ?? 2);
      daily.time.forEach((dateStr, idx)=>{
        const code = daily.weathercode[idx];
        const desc = WMO_DESC[code] || "‚Äî";
        const max = convertTemp(daily.temperature_2m_max[idx]);
        const min = convertTemp(daily.temperature_2m_min[idx]);
        const pop = daily.precipitation_probability_max?.[idx] ?? 0;
        const wind = Math.round(daily.windspeed_10m_max?.[idx] || 0);
        const el = document.createElement("article");
        el.className = "card" + (idx===0?" today":"");
        el.innerHTML = `
          <div class="date">${new Date(dateStr + "T00:00:00").toLocaleDateString(undefined, { weekday:"short", day:"2-digit", month:"short", timeZone: timezone })}</div>
          <div class="big">
            <span class="icon">${getIconByCode(code)}</span>
            <div class="temp">${max}${unitSymbol()} / <span style="color:#6b93b2">${min}${unitSymbol()}</span></div>
          </div>
          <div class="desc">${desc}</div>
          <div class="row"><span>Viento m√°x</span><b>${wind} km/h</b></div>
          <div class="row"><span>Prob. precip.</span><b>${pop}%</b></div>`;
        cards.appendChild(el);
      });
    }

    async function fetchAll(lat, lon, placeLabel){
      $("#place").textContent = placeLabel || `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`;
      const cards = $("#cards");
      cards.innerHTML = "";
      cards.appendChild(renderLoader());

      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", lat);
      url.searchParams.set("longitude", lon);
      url.searchParams.set("current", "temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m");
      url.searchParams.set("daily", "weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max");
      url.searchParams.set("timezone", "auto");

      try{
        const res = await fetch(url.toString());
        if(!res.ok) throw new Error("Error de red ("+res.status+")");
        const data = await res.json();
        if(data.current){ renderCurrent(data.current, data.timezone); } else { $("#current-desc").textContent = "Sin datos actuales."; }
        renderDaily(data);
      }catch(e){
        console.error("Error al pedir datos:", e);
        cards.innerHTML = `<div class="card">Ups, no pude traer los datos. ${e.message} üòÖ</div>`;
      }
    }

    async function geocodeCity(name){
      const url = new URL("https://geocoding-api.open-meteo.com/v1/search");
      url.searchParams.set("name", name);
      url.searchParams.set("count", "1");
      url.searchParams.set("language", "es");
      url.searchParams.set("format", "json");
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error("No se pudo geocodificar la ciudad");
      const data = await res.json();
      if(!data.results || !data.results.length) throw new Error("No encontr√© esa ciudad");
      const c = data.results[0];
      return { lat:c.latitude, lon:c.longitude, label:`${c.name}, ${c.admin1 || c.country}` };
    }

    $("#search").addEventListener("click", async ()=>{
      const name = $("#city").value.trim();
      if(!name) return;
      try{
        const {lat, lon, label} = await geocodeCity(name);
        fetchAll(lat, lon, label);
      }catch(e){
        console.error(e);
        $("#place").textContent = "Error: " + e.message;
        $("#cards").innerHTML = `<div class="card">Prob√° con otra ciudad. üôè</div>`;
      }
    });
    $("#city").addEventListener("keydown", (ev)=>{ if(ev.key==='Enter') $("#search").click(); });

    $("#geo").addEventListener("click", ()=>{
      if(!navigator.geolocation){
        fetchAll(-34.61, -58.38, "Buenos Aires (fallback)");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        ({coords:{latitude:lat, longitude:lon}})=> fetchAll(lat, lon, "Tu ubicaci√≥n"),
        (err)=>{ console.warn("Geo denegada:", err); fetchAll(-34.61, -58.38, "Buenos Aires (permiso denegado)"); }
      );
    });

    $("#toggle-unit").addEventListener("click", ()=>{
      prefs.unit = (prefs.unit === 'C') ? 'F' : 'C';
      localStorage.setItem('unit', prefs.unit);
      updatePrefChips();
      if(window.lastCoords){ fetchAll(window.lastCoords.lat, window.lastCoords.lon, window.lastCoords.label); }
    });
    $("#toggle-theme").addEventListener("click", ()=>{
      prefs.theme = (prefs.theme === 'auto') ? 'dark' : (prefs.theme === 'dark' ? 'light' : 'auto');
      localStorage.setItem('theme', prefs.theme);
      applyThemePref(); updatePrefChips();
    });

    const _fetchAll = fetchAll;
    fetchAll = function(lat, lon, label){ window.lastCoords = {lat, lon, label}; return _fetchAll(lat, lon, label); };

    (function init(){
      fetchAll(-34.61, -58.38, "Buenos Aires (inicio)");
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          ({coords:{latitude:lat, longitude:lon}})=> fetchAll(lat, lon, "Tu ubicaci√≥n"),
          (err)=> console.warn("Geo no disponible/denegada:", err)
        );
      }
    })();
  </script>
</body>
</html>
